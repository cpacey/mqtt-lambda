machine:
    environment:
        DOCKER_BUILD_REGISTRY: cantireinnovations
    node:
        version: 4.1.0
    services:
        - docker

dependencies:
    cache_directories:
        - "~/cache"
    override:
        - circle/cacheDockerImages.sh
        - docker run -p 1883:1883 --name mosquitto -d ansi/mosquitto
        - npm prune
        - npm install

test:
    override:
        - npm run ci
        - npm run docker.build

deployment:
    publish:
        branch: master
        owner: CanTireInnovations
        commands:
            - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" -e no-reply@cantireinnovations.com

            - npm run docker.buildAndPush:
                environment:
                    DOCKER_BUILD_TAG: $CIRCLE_SHA1
            - echo $CIRCLE_SHA1 > $CIRCLE_ARTIFACTS/DOCKER_BUILD_TAG.txt

            - npm run docker.buildAndPush:
                environment:
                    DOCKER_BUILD_TAG: latest

